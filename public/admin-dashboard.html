<!DOCTYPE html> 
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Spinner-Animation (wird im dynamisch erstellten Overlay verwendet) */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <button id="logout-btn">Logout</button>
  
  <h2>News erstellen</h2>
  <form id="newsForm" enctype="multipart/form-data">
      <input type="hidden" id="news-id">
      <label for="title">Titel:</label>
      <input type="text" id="title" required>
      
      <label for="content">Inhalt:</label>
      <textarea id="content" required></textarea>
      
      <label for="media">Bilder/Videos hochladen:</label>
      <input type="file" id="media" name="media" multiple accept=".png,.jpg,.jpeg,.gif,.mp4,.webm,.ogg,.mkv">
  
      <button type="submit">Speichern</button>
  </form>
  
  <h2>Bestehende News</h2>
  <ul id="news-list"></ul>
  
  <script src="js/admin.js" defer></script>
  <script>
    // Logout-Button
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await fetch("/admin-logout", { method: "POST" });
      window.location.href = "/admin.html"; 
    });

    async function fetchNews() {
      try {
        const response = await fetch("/news");
        if (!response.ok) throw new Error("Fehler beim Abrufen der News");
        const news = await response.json();
        const newsList = document.getElementById("news-list");
        newsList.innerHTML = "";

        news.forEach(item => {
          let mediaElements = '';
          if (item.media && item.media.length > 0) {
            item.media.forEach(mediaUrl => {
                const isVideo = mediaUrl.toLowerCase().endsWith('.mp4') ||
                mediaUrl.toLowerCase().endsWith('.webm') ||
                mediaUrl.toLowerCase().endsWith('.ogg') ||
                mediaUrl.toLowerCase().endsWith('.mkv');

              if (isVideo) {
                mediaElements += `<video src="${mediaUrl}" width="320" height="240" controls></video>`;
              } else {
                mediaElements += `<img src="${mediaUrl}" alt="Bild" style="max-width: 300px;">`;
              }
            });
          }

          const li = document.createElement("li");
          li.innerHTML = `
            <h3>${item.title}</h3>
            <p>${item.content}</p>
            ${mediaElements}
            <button class="edit-btn" data-id="${item.id}" data-title="${item.title}" data-content="${item.content}">Bearbeiten</button>
            <button class="delete-btn" data-id="${item.id}">L√∂schen</button>
          `;
          newsList.appendChild(li);
        });

        // Event Listener f√ºr Bearbeiten und L√∂schen
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', function() {
            const id = this.dataset.id;
            const title = this.dataset.title;
            const content = this.dataset.content;
            editNews(id, title, content);
          });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
          button.addEventListener('click', function() {
            const id = this.dataset.id;
            deleteNews(id);
          });
        });
      } catch (error) {
        console.error("Fehler beim Abrufen der News:", error);
      }
    }

    async function deleteNews(id) {
      try {
        const response = await fetch(`/news/${id}`, { method: "DELETE" });
        if (!response.ok) throw new Error("Fehler beim L√∂schen der News");
        await fetchNews();
      } catch (error) {
        console.error("Fehler beim L√∂schen der News:", error);
      }
    }

    function editNews(id, title, content) {
      document.getElementById("news-id").value = id;
      document.getElementById("title").value = title;
      document.getElementById("content").value = content;
    }

    document.getElementById("newsForm").addEventListener("submit", async function(event) {
      event.preventDefault(); // Standard-Formular-Submit verhindern

      // Dynamisch erstelltes Overlay (zentriert, mit Blur-Effekt)
      const overlay = document.createElement("div");
      overlay.id = "overlay";
      overlay.style.position = "fixed";
      overlay.style.top = 0;
      overlay.style.left = 0;
      overlay.style.width = "100%";
      overlay.style.height = "100%";
      overlay.style.background = "rgba(255,255,255,0.8)";
      overlay.style.backdropFilter = "blur(5px)";
      overlay.style.zIndex = 1000;
      overlay.style.display = "flex";
      overlay.style.flexDirection = "column";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";

      // Spinner
      const spinner = document.createElement("div");
      spinner.className = "spinner";
      spinner.style.border = "4px solid #f3f3f3";
      spinner.style.borderTop = "4px solid #3498db";
      spinner.style.borderRadius = "50%";
      spinner.style.width = "50px";
      spinner.style.height = "50px";
      spinner.style.animation = "spin 1s linear infinite";
      spinner.style.marginBottom = "1rem";

      // Nachricht
      const message = document.createElement("p");
      message.textContent = "News werden erstellt, bitte warten...";

      // Elemente zum Overlay hinzuf√ºgen
      overlay.appendChild(spinner);
      overlay.appendChild(message);

      // Overlay zur Seite hinzuf√ºgen
      document.body.appendChild(overlay);

      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      const mediaFiles = document.getElementById("media").files;

      if (!title || !content) {
        alert("Bitte Titel und Inhalt eingeben!");
        document.body.removeChild(overlay);
        return;
      }

      const formData = new FormData();
      formData.append("title", title);
      formData.append("content", content);

      // Alle Dateien aus dem File-Input in FormData packen
      for (const file of mediaFiles) {
        formData.append("media", file);
        console.log(`üìÇ Datei hinzugef√ºgt: ${file.name}`);
      }

      console.log("üì§ Sende FormData an Server...", [...formData.entries()]);

      try {
        const response = await fetch("/news", {
          method: "POST",
          body: formData // Browser setzt automatisch den richtigen Content-Type
        });
        if (!response.ok) throw new Error("Fehler beim Speichern der News");

        console.log("‚úÖ News erfolgreich gespeichert!");
        document.getElementById("newsForm").reset();
        await fetchNews();
      } catch (error) {
        console.error("‚ùå Fehler beim Speichern der News:", error);
        alert("Fehler beim Speichern der News");
      } finally {
        // Overlay entfernen
        document.body.removeChild(overlay);
      }
    });

    fetchNews(); 
  </script>
</body>
</html>
