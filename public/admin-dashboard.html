<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <h1>Admin Dashboard</h1>
    <button id="logout-btn">Logout</button>
    
    <h2>News erstellen</h2>
    <form id="newsForm" enctype="multipart/form-data">
        <input type="hidden" id="news-id">
        <label for="title">Titel:</label>
        <input type="text" id="title" required>
        
        <label for="content">Inhalt:</label>
        <textarea id="content" required></textarea>
        
        <label for="media">Bilder/Videos hochladen:</label>
        <input type="file" name="media" multiple accept=".png,.jpg,.jpeg,.gif,.mp4,.webm,.ogg,.mkv">

        
    
        <button type="submit">Speichern</button>
    </form>
    
    
    
    <h2>Bestehende News</h2>
    <ul id="news-list"></ul>
    <script src="js/admin.js" defer></script>

    <script>
        document.getElementById("logout-btn").addEventListener("click", async () => {
            await fetch("/admin-logout", { method: "POST" });
            window.location.href = "/admin.html"; 
        });

        async function fetchNews() {
    try {
        const response = await fetch("/news");
        if (!response.ok) throw new Error("Fehler beim Abrufen der News");
        const news = await response.json();
        const newsList = document.getElementById("news-list");
        newsList.innerHTML = "";

        news.forEach(item => {
            let mediaElements = '';
            if (item.media && item.media.length > 0) {
                item.media.forEach(mediaUrl => {
                    const isVideo = mediaUrl.toLowerCase().endsWith('.mp4') || mediaUrl.toLowerCase().endsWith('.webm') || mediaUrl.toLowerCase().endsWith('.ogg');
                    if (isVideo) {
                        mediaElements += `<video src="${mediaUrl}" width="320" height="240" controls></video>`;
                    } else {
                        mediaElements += `<img src="${mediaUrl}" alt="Bild" style="max-width: 300px;">`;
                    }
                });
            }

            const li = document.createElement("li");
            li.innerHTML = `
                <h3>${item.title}</h3>
                <p>${item.content}</p>
                ${mediaElements}
                <button class="edit-btn" data-id="${item.id}" data-title="${item.title}" data-content="${item.content}">Bearbeiten</button>
                <button class="delete-btn" data-id="${item.id}">L√∂schen</button>
            `;
            newsList.appendChild(li);
        });

        // Event Listener hinzuf√ºgen, nachdem die News geladen wurden
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const title = this.dataset.title;
                const content = this.dataset.content;
                editNews(id, title, content);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                deleteNews(id);
            });
        });
    } catch (error) {
        console.error("Fehler beim Abrufen der News:", error);
    }
}

        
        async function deleteNews(id) {
            try {
                const response = await fetch(`/news/${id}`, { method: "DELETE" });
                if (!response.ok) throw new Error("Fehler beim L√∂schen der News");
                await fetchNews();
            } catch (error) {
                console.error("Fehler beim L√∂schen der News:", error);
            }
        }
        
        function editNews(id, title, content) {
            document.getElementById("news-id").value = id;
            document.getElementById("title").value = title;
            document.getElementById("content").value = content;
        }
        

    document.getElementById("newsForm").addEventListener("submit", async function(event) {
    event.preventDefault(); // WICHTIG: Verhindert das Standardverhalten des Formulars
    
    const title = document.getElementById("title").value.trim();
    const content = document.getElementById("content").value.trim();
    const mediaFiles = document.getElementById("media").files;

    if (!title || !content) {
        alert("Bitte Titel und Inhalt eingeben!");
        return;
    }

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);

        // Alle Dateien aus dem File-Input in FormData packen
        for (const file of mediaFiles) {
            formData.append("media", file);
            console.log(`üìÇ Datei hinzugef√ºgt: ${file.name}`);
        }

        console.log("üì§ Sende FormData an Server...", [...formData.entries()]);

        try {
            const response = await fetch("/news", {
                method: "POST",
                body: formData // KEIN `Content-Type` setzen!  Der Browser setzt den Content-Type automatisch auf 'multipart/form-data'
            });
            if (!response.ok) throw new Error("Fehler beim Speichern der News");


            console.log("‚úÖ News erfolgreich gespeichert!");
            document.getElementById("newsForm").reset();
            await fetchNews();

        } catch (error) {
            console.error("‚ùå Fehler beim Speichern der News:", error);
        } 

    });


        
        fetchNews(); 
    </script>
  

</body>
</html>
