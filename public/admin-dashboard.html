<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Spinner-Animation (wird im dynamisch erstellten Overlay verwendet) */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Admin Dashboard</h1>
    <button id="logout-btn">Logout</button>

    <h2>News erstellen/bearbeiten</h2>
    <form id="newsForm" enctype="multipart/form-data">
        <input type="hidden" id="news-id">
        <label for="title">Titel:</label>
        <input type="text" id="title" required>

        <label for="content">Inhalt:</label>
        <textarea id="content" required></textarea>

        <div id="existing-media">
            <!-- Hier werden die vorhandenen Medien angezeigt -->
        </div>

        <label for="media">Bilder/Videos hochladen:</label>
        <input type="file" id="media" name="media" multiple accept=".png,.jpg,.jpeg,.gif,.mp4,.webm,.ogg,.mkv">

        <button type="submit">Speichern</button>
        <button type="button" id="cancel-edit-btn" style="display:none;">Abbrechen</button>
    </form>

    <h2>Bestehende News</h2>
    <ul id="news-list"></ul>

    <script src="js/admin.js" defer></script>
    <script>
        // Logout-Button
        document.getElementById("logout-btn").addEventListener("click", async () => {
            await fetch("/admin-logout", { method: "POST" });
            window.location.href = "/admin.html";
        });

        async function fetchNews() {
            try {
                const cacheBuster = new Date().getTime(); // Aktuelle Zeit als Cache-Buster
    const response = await fetch(`/news?cb=${cacheBuster}`);
    if (!response.ok) throw new Error("Fehler beim Abrufen der News");
    const news = await response.json();
                const newsList = document.getElementById("news-list");
                newsList.innerHTML = "";

                news.forEach(item => {
                    const li = document.createElement("li");

                    const h3 = document.createElement("h3");
                    h3.textContent = item.title;
                    li.appendChild(h3);

                    const p = document.createElement("p");
                    p.textContent = item.content;
                    li.appendChild(p);

                    if (item.media && item.media.length > 0) {
                        item.media.forEach(mediaUrl => {
                            const isVideo = mediaUrl.toLowerCase().endsWith('.mp4') ||
                                mediaUrl.toLowerCase().endsWith('.webm') ||
                                mediaUrl.toLowerCase().endsWith('.ogg') ||
                                mediaUrl.toLowerCase().endsWith('.mkv');

                            if (isVideo) {
                                const video = document.createElement("video");
                                video.src = mediaUrl;
                                video.width = 320;
                                video.height = 240;
                                video.controls = true;
                                li.appendChild(video);
                            } else {
                                const img = document.createElement("img");
                                img.src = mediaUrl;
                                img.alt = "Bild";
                                img.style.maxWidth = "300px";
                                li.appendChild(img);
                            }
                        });
                    }

                    const editButton = document.createElement("button");
                    editButton.textContent = "Bearbeiten";
                    editButton.classList.add("edit-btn");
                    editButton.dataset.id = item.id;
                    editButton.addEventListener('click', function() {
                        const id = this.dataset.id;
                        editNews(id);
                    });
                    li.appendChild(editButton);

                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Löschen";
                    deleteButton.classList.add("delete-btn");
                    deleteButton.dataset.id = item.id;
                    deleteButton.addEventListener('click', function() {
                        const id = this.dataset.id;
                        deleteNews(id);
                    });
                    li.appendChild(deleteButton);

                    newsList.appendChild(li);
                });
            } catch (error) {
                console.error("Fehler beim Abrufen der News:", error);
            }
        }

        async function deleteNews(id) {
            try {
                const response = await fetch(`/news/${id}`, { method: "DELETE" });
                if (!response.ok) throw new Error("Fehler beim Löschen der News");
                await fetchNews();
            } catch (error) {
                console.error("Fehler beim Löschen der News:", error);
            }
        }

        async function editNews(id) {
            try {
                const response = await fetch(`/news/${id}`);
                if (!response.ok) throw new Error("Fehler beim Abrufen der News");
                const newsItem = await response.json();

                document.getElementById("news-id").value = newsItem.id;
                document.getElementById("title").value = newsItem.title;
                document.getElementById("content").value = newsItem.content;

                // Vorhandene Medien anzeigen
                const existingMediaDiv = document.getElementById("existing-media");
                existingMediaDiv.innerHTML = ''; // Clear existing media
                if (newsItem.media && newsItem.media.length > 0) {
                    newsItem.media.forEach((mediaUrl, index) => {
                        const isVideo = mediaUrl.toLowerCase().endsWith('.mp4') ||
                            mediaUrl.toLowerCase().endsWith('.webm') ||
                            mediaUrl.toLowerCase().endsWith('.ogg') ||
                            mediaUrl.toLowerCase().endsWith('.mkv');

                        let mediaElement;
                        if (isVideo) {
                            mediaElement = document.createElement('video');
                            mediaElement.src = mediaUrl;
                            mediaElement.width = 320;
                            mediaElement.height = 240;
                            mediaElement.controls = true;
                        } else {
                            mediaElement = document.createElement('img');
                            mediaElement.src = mediaUrl;
                            mediaElement.alt = "Bild";
                            mediaElement.style.maxWidth = "300px";
                        }

                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Entfernen';
                        removeButton.classList.add('remove-existing-media-btn');
                        removeButton.dataset.mediaIndex = index;
                        removeButton.addEventListener('click', function() {
                            removeExistingMedia(newsItem.id, index);
                        });

                        const mediaContainer = document.createElement('div');
                        mediaContainer.appendChild(mediaElement);
                        mediaContainer.appendChild(removeButton);
                        existingMediaDiv.appendChild(mediaContainer);
                    });
                }
                document.getElementById("cancel-edit-btn").style.display = "inline-block";
                document.getElementById("cancel-edit-btn").addEventListener('click', function() {
                    cancelEdit();
                });
            } catch (error) {
                console.error("Fehler beim Abrufen der News:", error);
            }
        }

        async function removeExistingMedia(newsId, mediaIndex) {
  try {
    const response = await fetch(`/news/${newsId}/media/${mediaIndex}`, { method: "DELETE" });
    if (!response.ok) throw new Error("Fehler beim Entfernen des Mediums");
    
    // Parse JSON response
    const result = await response.json();
    console.log("Delete response:", result);
    
    // Now reload the news and edit form
    await fetchNews();
    await editNews(newsId);
  } catch (error) {
    console.error("Fehler beim Entfernen des Mediums:", error);
  }
} 


        async function cancelEdit() {
            document.getElementById("newsForm").reset();
            document.getElementById("news-id").value = "";
            document.getElementById("existing-media").innerHTML = "";
            document.getElementById("cancel-edit-btn").style.display = "none";
        }

        document.getElementById("newsForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    // Show upload overlay
    const overlay = document.createElement("div");
    overlay.id = "overlay";
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.background = "rgba(255,255,255,0.8)";
    overlay.style.backdropFilter = "blur(5px)";
    overlay.style.zIndex = 1000;
    overlay.style.display = "flex";
    overlay.style.flexDirection = "column";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";

    // Spinner
    const spinner = document.createElement("div");
    spinner.className = "spinner";
    spinner.style.border = "4px solid #f3f3f3";
    spinner.style.borderTop = "4px solid #3498db";
    spinner.style.borderRadius = "50%";
    spinner.style.width = "50px";
    spinner.style.height = "50px";
    spinner.style.animation = "spin 1s linear infinite";
    spinner.style.marginBottom = "1rem";

    // Message with more detailed progress information
    const message = document.createElement("p");
    message.id = "upload-message";
    message.textContent = "Vorbereitung zum Hochladen...";

    // Progress element for large uploads
    const progressContainer = document.createElement("div");
    progressContainer.style.width = "80%";
    progressContainer.style.maxWidth = "400px";
    progressContainer.style.marginTop = "10px";
    
    const progressBar = document.createElement("div");
    progressBar.id = "upload-progress";
    progressBar.style.width = "100%";
    progressBar.style.height = "20px";
    progressBar.style.backgroundColor = "#f3f3f3";
    progressBar.style.borderRadius = "10px";
    progressBar.style.overflow = "hidden";
    
    const progressFill = document.createElement("div");
    progressFill.id = "progress-fill";
    progressFill.style.width = "0%";
    progressFill.style.height = "100%";
    progressFill.style.backgroundColor = "#4CAF50";
    progressFill.style.transition = "width 0.3s";
    
    progressBar.appendChild(progressFill);
    progressContainer.appendChild(progressBar);

    // Add elements to overlay
    overlay.appendChild(spinner);
    overlay.appendChild(message);
    overlay.appendChild(progressContainer);
    document.body.appendChild(overlay);

    // Update progress function (can be called from outside)
    window.updateUploadProgress = function(percent, statusText) {
        const fill = document.getElementById("progress-fill");
        const msg = document.getElementById("upload-message");
        if (fill) fill.style.width = percent + "%";
        if (msg && statusText) msg.textContent = statusText;
    };

    const id = document.getElementById("news-id").value;
    const title = document.getElementById("title").value.trim();
    const content = document.getElementById("content").value.trim();
    const mediaFiles = document.getElementById("media").files;

    if (!title || !content) {
        alert("Bitte Titel und Inhalt eingeben!");
        document.body.removeChild(overlay);
        return;
    }

    const formData = new FormData();
    formData.append("title", title);
    formData.append("content", content);

    // If there are large files, update the message
    let totalSize = 0;
    for (const file of mediaFiles) {
        formData.append("media", file);
        totalSize += file.size;
        console.log(`📂 Datei hinzugefügt: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`);
    }

    if (totalSize > 50 * 1024 * 1024) { // If total size > 50MB
        window.updateUploadProgress(0, `Große Dateien erkannt (${(totalSize / (1024 * 1024)).toFixed(2)} MB). Das Hochladen kann einige Minuten dauern...`);
    }

    try {
        // Track upload start time for large files
        const startTime = Date.now();
        let uploadMethod = "POST";
        let uploadUrl = "/news";
        
        if (id) {
            uploadMethod = "PUT";
            uploadUrl = `/news/${id}`;
        }
        
        // Regular update for large uploads to show progress is happening
        let uploadTimer = null;
        if (totalSize > 20 * 1024 * 1024) { // For files > 20MB
            let seconds = 0;
            uploadTimer = setInterval(() => {
                seconds += 1;
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(0);
                window.updateUploadProgress(
                    Math.min(95, Math.floor(seconds * 3)), // Cap at 95% until complete
                    `Upload läuft seit ${elapsedTime} Sekunden. Bitte warten...`
                );
            }, 1000);
        }
        
        // Perform the actual upload
        const response = await fetch(uploadUrl, {
            method: uploadMethod,
            body: formData
        });
        
        // Clear timer if set
        if (uploadTimer) clearInterval(uploadTimer);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server Error: ${errorText}`);
        }

        // Update progress to 100%
        window.updateUploadProgress(100, "✅ Upload erfolgreich abgeschlossen!");
        
        console.log("✅ News erfolgreich gespeichert!");
        document.getElementById("newsForm").reset();
        document.getElementById("news-id").value = "";
        document.getElementById("existing-media").innerHTML = "";
        document.getElementById("cancel-edit-btn").style.display = "none";
        
        // Small delay to show 100% completion before refreshing
        setTimeout(async () => {
            await fetchNews();
            document.body.removeChild(overlay);
        }, 500);
    } catch (error) {
        console.error("❌ Fehler beim Speichern der News:", error);
        window.updateUploadProgress(0, `❌ Fehler: ${error.message}`);
        
        // Keep the error visible for a moment before removing overlay
        setTimeout(() => {
            document.body.removeChild(overlay);
            alert(`Fehler beim Speichern der News: ${error.message}`);
        }, 2000);
    }
});

        fetchNews();
    </script>
</body>
</html>
